<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Игры: Цвет и Форма</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css?v=2" />
  <script src="voice.js"></script>
</head>
<body>
  <!-- Меню -->
  <div class="screen active" id="menuScreen">
    <div class="screen-inner">
      <h1>Детские игры: Цвет и Форма</h1>
      <p>Выбери игру:</p>
      <div class="menu-buttons">
        <button class="menu-btn" data-mode="color">
          Игра «Найди цвет»
          <span>нажми на нужный цвет</span>
        </button>
        <button class="menu-btn" data-mode="shape">
          Игра «Найди форму»
          <span>круг, квадрат, треугольник</span>
        </button>
        <button class="menu-btn" data-mode="both">
          Игра «Цвет + форма»
          <span>найди, например, красный круг</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Экран игры -->
  <div class="screen" id="gameScreen">
    <div class="screen-inner">
      <h2 id="gameTitle">Игра</h2>

      <div class="task" id="taskText">
        Нажми на цвет: <span class="highlight" id="taskHighlight">...</span>
      </div>

      <div class="shapes" id="shapes"></div>

      <div class="info">
        Счёт: <span class="score" id="score">0</span>
      </div>

      <div class="btn-row">
        <button class="btn" id="nextBtn">Следующий раунд</button>
        <button class="btn secondary" id="backBtn">Назад в меню</button>
      </div>
    </div>
  </div>

  <script>
    const bodyEl = document.body;

    // Один источник правды для цветов
    const COLORS = [
      { key: 'red',    nameRu: 'красный',    hex: '#ef4444' },
      { key: 'blue',   nameRu: 'синий',      hex: '#3b82f6' },
      { key: 'green',  nameRu: 'зелёный',    hex: '#22c55e' },
      { key: 'yellow', nameRu: 'жёлтый',     hex: '#eab308' },
      { key: 'purple', nameRu: 'фиолетовый', hex: '#a855f7' },
      { key: 'orange', nameRu: 'оранжевый',  hex: '#f97316' }
    ];

    const SHAPES = [
      { key: 'circle',   nameRu: 'круг' },
      { key: 'square',   nameRu: 'квадрат' },
      { key: 'triangle', nameRu: 'треугольник' }
    ];

    const menuScreen   = document.getElementById('menuScreen');
    const gameScreen   = document.getElementById('gameScreen');
    const gameTitleEl  = document.getElementById('gameTitle');
    const taskTextEl   = document.getElementById('taskText');
    const shapesCont   = document.getElementById('shapes');
    const scoreEl      = document.getElementById('score');
    const nextBtn      = document.getElementById('nextBtn');
    const backBtn      = document.getElementById('backBtn');

    let currentMode = 'color';   // 'color' | 'shape' | 'both'
    let currentTarget = null;    // { colorKey?, shapeKey? }
    let currentTaskText = '';
    let score = 0;
    let canClick = true;

    const correctSound = new Audio('./correct.mp3');
    const wrongSound   = new Audio('./wrong.mp3');
    correctSound.volume = 0.7;
    wrongSound.volume   = 0.7;

    bodyEl.classList.add('menu-bg');

    function showScreen(id) {
      menuScreen.classList.remove('active');
      gameScreen.classList.remove('active');
      document.getElementById(id).classList.add('active');
    }

    function getRandomFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getRandomItems(arr, count) {
      const pool = [...arr];
      const res = [];
      while (res.length < count && pool.length > 0) {
        const idx = Math.floor(Math.random() * pool.length);
        res.push(pool.splice(idx, 1)[0]);
      }
      return res;
    }

    function clearHighlights(container) {
      container.querySelectorAll('.shape').forEach(el => {
        el.classList.remove('correct', 'wrong');
      });
    }

    function speakTask() {
      if (currentTaskText && typeof speak === 'function') {
        speak(currentTaskText, 'ru-RU');
      }
    }

    function startGame(mode) {
      currentMode = mode;
      score = 0;
      scoreEl.textContent = score;

      bodyEl.classList.remove('menu-bg', 'color-bg', 'shape-bg', 'both-bg');
      if (mode === 'color') {
        bodyEl.classList.add('color-bg');
        gameTitleEl.textContent = 'Игра «Найди цвет»';
      } else if (mode === 'shape') {
        bodyEl.classList.add('shape-bg');
        gameTitleEl.textContent = 'Игра «Найди форму»';
      } else {
        bodyEl.classList.add('both-bg');
        gameTitleEl.textContent = 'Игра «Цвет + форма»';
      }

      showScreen('gameScreen');
      newRound();
    }

    function newRound() {
      shapesCont.innerHTML = '';
      clearHighlights(shapesCont);
      currentTarget = null;
      currentTaskText = '';
      canClick = true;

      if (currentMode === 'color') {
        // Нажми на цвет: <слово>
        taskTextEl.innerHTML =
          'Нажми на цвет: <span class="highlight" id="taskHighlight"></span>';
        const taskHighlight = document.getElementById('taskHighlight');

        const roundColors = getRandomItems(COLORS, 4);
        const targetColor = getRandomFrom(roundColors);

        // единый источник: targetColor
        currentTarget = { colorKey: targetColor.key };
        taskHighlight.textContent = targetColor.nameRu;
        currentTaskText = 'Нажми на ' + targetColor.nameRu + ' цвет';

        roundColors.forEach(c => {
          const wrap = document.createElement('div');
          wrap.className = 'shape';
          wrap.dataset.color = c.key;

          const inner = document.createElement('div');
          inner.className = 'shape-inner circle';
          inner.style.backgroundColor = c.hex;

          wrap.appendChild(inner);
          shapesCont.appendChild(wrap);
        });

      } else if (currentMode === 'shape') {
        taskTextEl.innerHTML =
          'Нажми на форму: <span class="highlight" id="taskHighlight"></span>';
        const taskHighlight = document.getElementById('taskHighlight');

        const roundShapes = getRandomItems(SHAPES, 3);
        const targetShape = getRandomFrom(roundShapes);

        currentTarget = { shapeKey: targetShape.key };
        taskHighlight.textContent = targetShape.nameRu;
        currentTaskText = 'Нажми на форму ' + targetShape.nameRu;

        roundShapes.forEach(s => {
          const wrap = document.createElement('div');
          wrap.className = 'shape';
          wrap.dataset.shape = s.key;

          const inner = document.createElement('div');
          inner.className = 'shape-inner';

          const colorHex = getRandomFrom(COLORS).hex;

          if (s.key === 'circle') {
            inner.classList.add('circle');
            inner.style.backgroundColor = colorHex;
          } else if (s.key === 'square') {
            inner.classList.add('square');
            inner.style.backgroundColor = colorHex;
          } else if (s.key === 'triangle') {
            inner.classList.add('triangle');
            inner.style.borderBottomColor = colorHex;
          }

          wrap.appendChild(inner);
          shapesCont.appendChild(wrap);
        });

      } else {
        taskTextEl.innerHTML =
          'Найди: <span class="highlight" id="taskHighlight"></span>';
        const taskHighlight = document.getElementById('taskHighlight');

        const targetColor = getRandomFrom(COLORS);
        const targetShape = getRandomFrom(SHAPES);

        currentTarget = {
          colorKey: targetColor.key,
          shapeKey: targetShape.key
        };

        const phrase = targetColor.nameRu + ' ' + targetShape.nameRu;
        taskHighlight.textContent = phrase;
        currentTaskText = 'Найди ' + phrase;

        const items = [];
        const used = new Set();

        items.push({
          isTarget: true,
          colorKey: targetColor.key,
          shapeKey: targetShape.key
        });
        used.add(targetColor.key + '-' + targetShape.key);

        while (items.length < 4) {
          const c = getRandomFrom(COLORS);
          const s = getRandomFrom(SHAPES);
          const key = c.key + '-' + s.key;
          if (used.has(key)) continue;
          used.add(key);
          items.push({
            isTarget: false,
            colorKey: c.key,
            shapeKey: s.key
          });
        }

        items.sort(() => Math.random() - 0.5);

        items.forEach(item => {
          const wrap = document.createElement('div');
          wrap.className = 'shape';
          wrap.dataset.color = item.colorKey;
          wrap.dataset.shape = item.shapeKey;

          const inner = document.createElement('div');
          inner.className = 'shape-inner';

          const colorHex = COLORS.find(c => c.key === item.colorKey).hex;

          if (item.shapeKey === 'circle') {
            inner.classList.add('circle');
            inner.style.backgroundColor = colorHex;
          } else if (item.shapeKey === 'square') {
            inner.classList.add('square');
            inner.style.backgroundColor = colorHex;
          } else if (item.shapeKey === 'triangle') {
            inner.classList.add('triangle');
            inner.style.borderBottomColor = colorHex;
          }

          wrap.appendChild(inner);
          shapesCont.appendChild(wrap);
        });
      }

      speakTask();
    }

    shapesCont.addEventListener('click', (e) => {
      const shapeEl = e.target.closest('.shape');
      if (!shapeEl || !canClick || !currentTarget) return;

      let isCorrect = false;

      if (currentMode === 'color') {
        const chosenColor = shapeEl.dataset.color;
        isCorrect = chosenColor === currentTarget.colorKey;
      } else if (currentMode === 'shape') {
        const chosenShape = shapeEl.dataset.shape;
        isCorrect = chosenShape === currentTarget.shapeKey;
      } else {
        const chosenColor = shapeEl.dataset.color;
        const chosenShape = shapeEl.dataset.shape;
        isCorrect =
          chosenColor === currentTarget.colorKey &&
          chosenShape === currentTarget.shapeKey;
      }

      if (isCorrect) {
        shapeEl.classList.add('correct');
        score++;
        scoreEl.textContent = score;

        correctSound.currentTime = 0;
        correctSound.play().catch(() => {});

        canClick = false;
        setTimeout(newRound, 800);
      } else {
        shapeEl.classList.add('wrong');
        wrongSound.currentTime = 0;
        wrongSound.play().catch(() => {});
        setTimeout(() => shapeEl.classList.remove('wrong'), 400);
      }
    });

    nextBtn.addEventListener('click', newRound);

    backBtn.addEventListener('click', () => {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      bodyEl.classList.remove('color-bg', 'shape-bg', 'both-bg');
      bodyEl.classList.add('menu-bg');
      showScreen('menuScreen');
    });

    document.querySelectorAll('.menu-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        startGame(btn.dataset.mode);
      });
    });
  </script>
</body>
</html>
